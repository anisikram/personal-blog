---
import { getCollection } from 'astro:content';
import BlogLayout from '../../layouts/BlogLayout.astro';
import MediaLightbox from '../../components/MediaLightbox.astro';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  return allPosts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await post.render();
---

<BlogLayout title={post.data.title}>
  <div class="container mx-auto px-4 py-8">
    <div class="flex flex-wrap lg:flex-nowrap">
      {headings && headings.length > 0 && (
        <aside class="w-full lg:w-1/4 lg:pr-8 mb-8 lg:mb-0">
          <div class="sticky top-20">
            <div class="p-4 bg-base-200 rounded-lg">
              <h2 class="text-xl font-bold mb-2">Table des matières</h2>
              <ul>
                {headings.map(heading => (
                  <li class={`ml-${(heading.depth - 1) * 4}`}>
                    <a href={`#${heading.slug}`}>{heading.text}</a>
                  </li>
                ))}
              </ul>
            </div>
          </div>
        </aside>
      )}

      <main class="w-full lg:w-3/4">
        <article class="prose lg:prose-xl max-w-none">
          <div class="text-center mb-8">
            <h1 class="text-4xl font-bold">{post.data.title}</h1>
            <p class="text-lg italic">
              Publié le: {post.data.date.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' })} par {post.data.author}
            </p>
          </div>
          <img src={post.data.image} alt={post.data.title} class="w-full h-auto rounded-lg mb-8">
          <div class="article-content space-y-6">
            <Content />
          </div>
        </article>
        <MediaLightbox targetSelector=".article-content img, .article-content svg" />
      </main>
    </div>
  </div>
</BlogLayout>

<style>
  :global(.article-content img),
  :global(.article-content svg) {
    display: block;
    margin: 2.5rem auto;
    max-width: min(100%, 52rem);
  }

  :global(.article-content img) {
    height: auto;
    width: auto;
  }

  :global(.article-content svg) {
    width: min(100%, 52rem);
    height: auto;
    max-height: 80vh;
  }

  :global(#media-lightbox-content) {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  :global(#media-lightbox-content img) {
    width: min(90vw, 80rem);
    height: auto;
  }

  :global(#media-lightbox-content svg) {
    max-width: 95vw;
    max-height: 85vh;
  }
</style>
